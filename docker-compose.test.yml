version: '3.8'

# Lightweight test configuration - runs without Ollama
# Usage: docker-compose -f docker-compose.test.yml up

services:
  # Backend API (without Ollama dependency)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: geetanjali-backend-test
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=test
      - DATABASE_URL=postgresql://geetanjali:geetanjali_test@postgres:5432/geetanjali_test
      - CHROMA_PERSIST_DIRECTORY=/app/chroma_data
      - OLLAMA_BASE_URL=http://localhost:11434
      - OLLAMA_ENABLED=false  # New flag to disable Ollama
      - LOG_LEVEL=INFO
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - geetanjali-network
    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: geetanjali-postgres-test
    environment:
      - POSTGRES_USER=geetanjali
      - POSTGRES_PASSWORD=geetanjali_test
      - POSTGRES_DB=geetanjali_test
    ports:
      - "5433:5432"  # Different port to avoid conflicts
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster tests, no persistence
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U geetanjali"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - geetanjali-network

networks:
  geetanjali-network:
    driver: bridge
